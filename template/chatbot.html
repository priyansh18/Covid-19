{% extends 'base.html' %}
{% load static %}
{% block title %}

Chatbot

{% endblock %}

{% block stylescss %}

<link rel="stylesheet" href="{% static 'css/chatbot.css'%}">
<style>
  /* Override base template styles for chatbot page only */
  html, body {
    background: #e8f4fd !important;
    margin: 0 !important;
    padding: 0 !important;
    height: 100vh !important;
    overflow: hidden !important;
  }
  
  .navbar {
    display: none !important;
  }
  
  .footer {
    display: none !important;
  }
  
  main {
    margin: 0 !important;
    padding: 0 !important;
    height: 100vh !important;
  }
  
  .container {
    margin: 0 !important;
    padding: 0 !important;
    max-width: none !important;
    width: 100% !important;
  }
  
  .msger {
    max-width: none !important;
    width: calc(100vw - 16px) !important;
    height: calc(100vh - 16px) !important;
    border-radius: 8px !important;
    border: none !important;
    box-shadow: none !important;
    background: white !important;
    margin: 8px !important;
    padding: 0 !important;
    z-index: 1 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  .msger-header {
    padding: 16px 20px !important;
    margin: 0 !important;
  }
  
  .msger-chat {
    padding: 16px 20px !important;
    margin: 0 !important;
    flex: 1 !important;
    overflow-y: auto !important;
    display: flex !important;
    flex-direction: column !important;
  }
  
  .msg {
    margin-bottom: 12px !important;
  }
  
  .msg-bubble {
    margin: 4px 0 !important;
    padding: 12px 16px !important;
  }
  
  .msger-inputarea {
    padding: 16px 20px !important;
    margin: 0 !important;
    display: flex !important;
    border-top: 1px solid #ddd !important;
    background: #f8f9fa !important;
  }
  
  .msger-input {
    flex: 1 !important;
    border: 1px solid #ddd !important;
    border-radius: 20px !important;
    padding: 10px 15px !important;
    margin-right: 10px !important;
    outline: none !important;
  }
  
  .msger-send-btn {
    background: #28a745 !important;
    color: white !important;
    border: none !important;
    border-radius: 20px !important;
    padding: 10px 20px !important;
    cursor: pointer !important;
    font-weight: bold !important;
  }
  
  .msger-send-btn:hover {
    background: #218838 !important;
  }
</style>

{% endblock %}

{% block content %}

<section class="msger">
    <header class="msger-header">
        <div class="msger-header-title">
            <i class="fas fa-bug"></i> Coronavirus Chatbot <i class="fas fa-bug"></i>
            <a href="/"><button style="margin-left:20px" type="button" class="btn btn-success">Returnto
                    HomePage!</button></a>
        </div>
    </header>
    <main class="msger-chat" id="msger">
        <div class="msg left-msg">
            <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)">
            </div>
            <div class="msg-bubble">
                <div class="msg-info">
                    <div class="msg-info-name">CoronaBot</div>
                </div>
                <div class="msg-text">
                    Hi, welcome to CoronaBot! Go ahead and send me a message. ðŸ˜„
                </div>
            </div>
        </div>
        {% if welcomeCovidResp %}
        {% for i,j in welcomeCovidResp %}
        <div class="msg right-msg">
            <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/145/145867.svg)">
            </div>
            <div class="msg-bubble">
                <div class="msg-info">
                    <div class="msg-info-name">CoronaBot</div>
                    <div class="msg-info-time">12:45</div>
                </div>
                <div class="msg-text">
                    <div>{{i}}</div>
                </div>
            </div>
        </div>
        <div class="msg left-msg">
            <div class="msg-img" style="background-image: url(https://image.flaticon.com/icons/svg/327/327779.svg)">
            </div>
            <div class="msg-bubble">
                <div class="msg-info">
                    <div class="msg-info-name">CoronaBot</div>
                </div>
                <div class="msg-text">
                    <div>{{j}}</div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

    </main>

    <form class="msger-inputarea" method="POST" action="{% url 'chatbot' %}" id="chatForm">
        {% csrf_token %}
        <input type="text" name="message" class="msger-input" id="textInput" placeholder="Enter your message..." required>
        <button type="submit" name="messageb" class="msger-send-btn">Send</button>
    </form>
</section>

{% endblock %}

{% block contentscript %}

<script src='https://use.fontawesome.com/releases/v5.0.13/js/all.js'></script>
<script>
    // Auto-scroll to bottom
    function scrollToBottom() {
        var elem = document.getElementById('msger');
        elem.scrollTop = elem.scrollHeight;
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Handle form submission with AJAX
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const messageInput = document.getElementById('textInput');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Add user message to chat
        addMessage(message, 'right-msg', 'You');
        
        // Clear input
        messageInput.value = '';
        
        // Send message to server
        fetch('{% url "chatbot" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'message=' + encodeURIComponent(message)
        })
        .then(response => response.json())
        .then(data => {
            // Add bot response to chat
            addMessage(data.response, 'left-msg', 'CoronaBot');
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage('Sorry, I encountered an error. Please try again.', 'left-msg', 'CoronaBot');
        });
    });
    
    // Function to add messages to chat
    function addMessage(text, messageClass, sender) {
        const chatContainer = document.getElementById('msger');
        const messageDiv = document.createElement('div');
        messageDiv.className = `msg ${messageClass}`;
        
        const imgUrl = messageClass === 'left-msg' ? 
            'https://image.flaticon.com/icons/svg/327/327779.svg' : 
            'https://image.flaticon.com/icons/svg/145/145867.svg';
        
        messageDiv.innerHTML = `
            <div class="msg-img" style="background-image: url(${imgUrl})"></div>
            <div class="msg-bubble">
                <div class="msg-info">
                    <div class="msg-info-name">${sender}</div>
                </div>
                <div class="msg-text">${text}</div>
            </div>
        `;
        
        chatContainer.appendChild(messageDiv);
        scrollToBottom();
    }
</script>

{% endblock %}